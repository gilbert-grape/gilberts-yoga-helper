{% extends "_base.html" %}

{% block content %}
{# Header with stats #}
<div class="mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
            <p class="text-gray-600">
                {% if total_count > 0 %}
                    {{ total_count }} Treffer gefunden
                    {% if new_count > 0 %}
                        <span class="inline-flex items-center ml-2 bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded">
                            {{ new_count }} neue
                        </span>
                    {% endif %}
                {% else %}
                    Willkommen bei Gilbert's Yoga Helper
                {% endif %}
            </p>
        </div>
        <div class="flex items-center gap-4 mt-2 sm:mt-0">
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="compact-checkbox" class="sr-only peer">
                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                <span class="ms-3 text-sm font-medium text-gray-700">Kompakt</span>
            </label>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="expanded-checkbox" class="sr-only peer">
                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                <span class="ms-3 text-sm font-medium text-gray-700">Aufgeklappt</span>
            </label>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="filter-checkbox" class="sr-only peer" {% if filter_enabled %}checked{% endif %}>
                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                <span class="ms-3 text-sm font-medium text-gray-700">Filter</span>
            </label>
        </div>
    </div>
</div>

{% if groups and groups|length > 0 %}
    {# Accordion container for grouped matches #}
    <div id="matches-accordion" data-accordion="collapse" data-active-classes="bg-gray-50" data-inactive-classes="bg-white">
        {% for group in groups %}
            {% include "_partials/_match_group.html" %}
        {% endfor %}
    </div>
{% else %}
    {# Empty State - no search terms configured #}
    <div class="bg-white rounded-lg shadow p-6">
        <div class="text-center py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">Keine Suchbegriffe</h3>
            <p class="mt-1 text-sm text-gray-500">
                Konfigurieren Sie Suchbegriffe, um Treffer zu finden.
            </p>
            <div class="mt-6">
                <a href="/admin/search-terms" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="-ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Suchbegriffe verwalten
                </a>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<style>
    /* Compact mode styles */
    body.compact-mode .match-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        gap: 0.5rem !important;
    }
    @media (min-width: 640px) {
        body.compact-mode .match-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
        }
    }
    @media (min-width: 1024px) {
        body.compact-mode .match-grid {
            grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
        }
    }
    @media (min-width: 1280px) {
        body.compact-mode .match-grid {
            grid-template-columns: repeat(6, minmax(0, 1fr)) !important;
        }
    }

    /* Compact card - show title wrapper at top */
    body.compact-mode .match-card .match-title-wrapper {
        display: block !important;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }

    /* Compact card body - horizontal layout */
    body.compact-mode .match-card .match-body {
        display: flex;
        flex-direction: row;
    }

    /* Compact card image - small square on left */
    body.compact-mode .match-card .match-image {
        aspect-ratio: 1/1 !important;
        width: 60px !important;
        min-width: 60px !important;
        max-width: 60px !important;
        height: 60px !important;
    }

    /* Compact card content - beside image */
    body.compact-mode .match-card .match-content {
        padding: 0.25rem 0.5rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex: 1;
        min-width: 0;
    }

    /* Hide normal title in compact mode (shown in wrapper instead) */
    body.compact-mode .match-card .match-title {
        display: none;
    }

    /* Compact price */
    body.compact-mode .match-card .match-price {
        font-size: 0.75rem;
        margin-bottom: 0;
        line-height: 1.2;
    }

    /* Compact meta */
    body.compact-mode .match-card .match-meta {
        font-size: 0.625rem;
        margin-top: 0.125rem;
    }
    body.compact-mode .match-card .match-meta .match-source-badge {
        display: none;
    }

    /* Smaller NEW badge in compact mode */
    body.compact-mode .match-card .new-badge {
        padding: 0 0.25rem;
        font-size: 8px;
        top: 2px;
        right: 2px;
    }
</style>
<script>
    // Cookie helper functions
    function setCookie(name, value, days) {
        const expires = new Date(Date.now() + days * 864e5).toUTCString();
        document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/; SameSite=Lax';
    }

    function getCookie(name) {
        const value = document.cookie.split('; ').find(row => row.startsWith(name + '='));
        return value ? decodeURIComponent(value.split('=')[1]) : null;
    }

    // Compact mode - load from cookie and apply
    const compactCheckbox = document.getElementById('compact-checkbox');
    const isCompact = getCookie('compact_mode') !== 'false'; // Default to true

    if (isCompact) {
        document.body.classList.add('compact-mode');
        compactCheckbox.checked = true;
    }

    compactCheckbox.addEventListener('change', function() {
        if (this.checked) {
            document.body.classList.add('compact-mode');
            setCookie('compact_mode', 'true', 365);
        } else {
            document.body.classList.remove('compact-mode');
            setCookie('compact_mode', 'false', 365);
        }
    });

    // Expanded mode - load from cookie and apply
    const expandedCheckbox = document.getElementById('expanded-checkbox');
    const isExpanded = getCookie('expanded_mode') !== 'false'; // Default to true

    if (isExpanded) {
        expandedCheckbox.checked = true;
    }

    // Function to expand/collapse all accordions
    function setAllAccordions(expanded) {
        document.querySelectorAll('[data-accordion-target]').forEach(button => {
            const targetId = button.getAttribute('data-accordion-target');
            const target = document.querySelector(targetId);
            const icon = button.querySelector('[data-accordion-icon]');

            if (expanded) {
                target.classList.remove('hidden');
                button.setAttribute('aria-expanded', 'true');
                icon.classList.add('rotate-180');
            } else {
                target.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
                icon.classList.remove('rotate-180');
            }
        });
    }

    // Apply expanded state on page load
    if (isExpanded) {
        setAllAccordions(true);
    }

    expandedCheckbox.addEventListener('change', function() {
        setCookie('expanded_mode', this.checked ? 'true' : 'false', 365);
        setAllAccordions(this.checked);
    });

    // Initialize accordion collapse/expand functionality (manual toggle)
    document.querySelectorAll('[data-accordion-target]').forEach(button => {
        button.addEventListener('click', () => {
            const targetId = button.getAttribute('data-accordion-target');
            const target = document.querySelector(targetId);
            const icon = button.querySelector('[data-accordion-icon]');
            const currentlyExpanded = button.getAttribute('aria-expanded') === 'true';

            // Toggle visibility
            if (currentlyExpanded) {
                target.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
                icon.classList.remove('rotate-180');
            } else {
                target.classList.remove('hidden');
                button.setAttribute('aria-expanded', 'true');
                icon.classList.add('rotate-180');
            }
        });
    });

    // Filter checkbox - save to cookie and reload
    document.getElementById('filter-checkbox').addEventListener('change', function() {
        setCookie('filter_mode', this.checked ? 'true' : 'false', 365);
        window.location.href = '/';
    });
</script>
{% endblock %}
